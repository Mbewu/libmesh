# File for inputting data so don't need command line!

#mesh_file = meshes/structured_tube_straight_tet.msh
#mesh_file = meshes/structured_tube_straight_tet_thin_bdy_layer.msh
#mesh_file = structured_tube_scaled_tet.msh
#mesh_file = structured_tube_unscaled_tet.msh
#mesh_file = structured_tube_scaled_quad_tet.msh
#mesh_file = meshes/structured_tube_scaled_nice_1_tet.msh #usual
#meshes/structured_tube_straight_tet_1024.msh
#mesh_file = meshes/tube_mesh_thin_1272_3_bdy.msh
#mesh_file = meshes/tube_mesh_669_no_bdy.msh
#mesh_file = meshes/tube_mesh_thin_1434_no_bdy.msh
#mesh_file = meshes/surface_mesh_no_holes_22.5_coarse.msh
#mesh_file = surface_mesh_no_holes_22.5.msh
#mesh_file = surface_mesh_22.5_no_holes_super_coarse.msh
#mesh_file = meshes/exodus.exo
#mesh_file = meshes/fine_mesh_truncated_labelled.msh
#mesh_file = meshes/bifurc-volume-mesh.msh #usual
#mesh_file = meshes/surface_mesh_no_holes_22.5_coarse.msh #usual
#mesh_file = meshes/structured_tube_expanding_tet.msh #usual
#mesh_file = meshes/tube_2D_expanding_tet.msh
output_folder = results/ #results/expanding_pipe_study_high_re/optimised_volume_0.1/ # exodus files can't have names longer than 80 expanding_pipe/straight_pipe_stab_expand_v50.0_working_small_stretch/
_read_1d_mesh = false
input_1d_edge_file = meshes/APLE0081560/output_airways_full.edge #meshes/APLE0036266/output_airways_full.edge
input_1d_node_file = meshes/APLE0081560/output_airways_full.node #meshes/APLE0036266/output_airways_full.node
num_generations_1 =2
num_generations_2 = 0
num_1d_trees = 1
no_refinement = 2
output_no_refinement = 2		#okay this only works for going to coarser mesh
fine_refinement = 0
prerefine = 0			# 1 - use prerefine function, 2 - use adaptive refinement function
quads = true #else tris
compare_results = false
fine_ref_solution = true		# in this case we need to have the system set up with the fine mesh and stuffs
results_folder_1 = results/supgpspg_convergence/4_norm/		# this is the reference folder
results_folder_2 = results/supgpspg_convergence/4_comp/
output_linear_iteration_count = true

# hmmm why does stokes stabilised not work with gmres
stokes = false
linear_shape_functions = false
stab = false
alpha = 0.1
geometry_type = 2 # 0 is pipe, 1 is single bifurcating pipe, 2 is cuboid, 3 is closed cuboid, 4 is real geometry with arb number of bifurcations
sim_type = 0		# 0 is 3d, 1 is 1d, 2 is 3d and 1d not coupled, 3 is 3d and 1d implicitly coupled, 4 is 3d and 1d explicitly coupled, 5 is 3d and 1d monolithically coupled
optimisation_stabilised = 1	# says whether we stabilise the neumann boundary by minimising gradients on the boundary
unsteady = 1		# 0 is steady, 1 is sin, 2 is ramp, 3 is cos shifted positive, 4 is negative sin, 5 is cos
# 0 is dirichlet parabolic inflow, 1 i pressure pressure, 2 is some kind of stress and 3 is pipe moving sinusoidically in a static fluid
# 4 is a lid driven cavity, 5 is exact solution comparison
problem_type = 1
threed = false
viscosity_controlled = false
compliance_1d = false
inertance_1d = false
restart_time = 0.
restart_time_step = 0
adaptive_refinement = false	# num time_steps between refinements
adaptive_time_stepping = false
neumann_stabilised = false
convective_form = true
backflow_stab_param = 0.2		#problematic if it is too big
neumann_stabilised_adjusted = false	#this is with flow taken from previous timestep
neumann_stabilised_adjusted_interpolated = false	#this is with flow interpolated from prev timestepp
constant_pressure = false
num_refinement_steps = 0
adaptive_newton_solve_limit = 5
reuse_preconditioner = false
tangential_optimisation = false
volume_optimisation = true
volume_optimisation_h_scaled =  false
optimisation_scaling_factor = 0.1
output_adjoint_variables = true
inflow_profile = 1
reverse_inflow_profile = 1
prescribed_flow = 0
old_geometry = 1
p2p1_stabilisation = false
opt_correction_term = false
discontinuous_linear_neumann = false
expanding_pipe = false
numerical_continuation_scaling_factor = 1.5
minimise_neumann_boundary = true
neumann_minimisation_parameter = 1.0


pressure_mag = 2. #0.2		#nondimensionalised
parent_pressure_mag = 2.
daughter_1_pressure_mag = 0.0
daughter_2_pressure_mag = 0.0
dt = 0.05
max_time_step = 10000.0		#don't be too crazy now
min_time_step = 0.001	#unfeasible otherwise
write_interval = 0.0001
period = 2.0
ramp_duration = 0.1
quadratic_ramp = false
end_time = 2.0
newton = false
direct = false
max_newton_iterations = 30

#scalings
reynolds_number_calculation = true
length_scale = 1.0		#for a radius 10mm=1cm pipe
velocity_scale = 20.0

nonlinear_tolerance = 1.e-6
outer_solver_rtol = 1.e-8
outer_solver_atol = 1.e-10
outer_solver_maxits = 10000		# well when you look at it you can kinda tell if it's converging or not
refine_fraction = 0.3
coarsen_fraction = 0.3
coarsen_threshold = 1.0
max_h_level = 5		#doesn't affect initial uniform refinements
nelem_target = 10000
face_level_mismatch_limit = 6
min_steps_between_dt_increase = 5
error_estimator = 0			# 0 is none 1 is calculating term peclet, 2 is dividing actual terms peclet, 3 is actual peclet, 4 is kelly
supg = false
pspg = false		#is glorious for convergence
lsic = false		#makes a diff to convergence
supg_convection = false
supg_convection_newton = false
supg_full_newton = true
supg_newton = false
supg_picard = false
supg_scale = 1.0			#if high then convergence slows...
pspg_newton = true
pspg_picard = false
ismail_supg_parameter = false
tezduyar_supg_parameter = false
tezduyar_supg_parameter_2 = false
supg_constant_constant = false
supg_laplacian = false		# this is incorrect at the moment!

# 0 is poiseuille, 1 is pedley, 2 is van ertbruggen, 3 - modified reynolds
resistance_type_1d = 0




reynolds_number = 1000.0
viscocity = 1.81e-7 #1.523e-7 0.1588e-1 correctval #0.001 #1400.8		#for air in mm^2/s
density = 1.14e-6 #1.176e-9 correctval
zeta_1 = -0.057
zeta_2 = 0.2096
zeta_3 = 0.00904
E = 3.3e10
viscocity_1d = 1.81e-7 #1.81e-7 0.1588e-1 correctval #0.001 #1400.8		#for air in mm^2/s
density_1d = 1.14e-6 #1.14e-6 correctval
flow_mag_1d = 2.0e6#1.14e-6 correctval
compliance_1d = false
inertance_1d = false
length_diam_ratio = 1.0


# different solver types. same_solver(0), diff_solvers(1)
# when using different solvers take care that the mat_mumps_icntl settings don't get the prefix ;)
# some solver options need to be in petsc and the code
solver_type = 0
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -ns1d_mat_mumps_icntl_28 2 -ns1d_mat_mumps_icntl_14 50 -ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package mumps -ns3d_mat_mumps_icntl_28 2 -ns3d_mat_mumps_icntl_14 50 -ns1d_ksp_view -ns3d_ksp_view'
#  alternative solver options - prefix stuff not working!

#solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 80 -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps'
#solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package superlu_dist -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package superlu_dist'
#solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package mumps -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -ns3d_mat_mumps_icntl_28 2 -ns3d_mat_mumps_icntl_14 50'
#solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package umfpack -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package umfpack'
direct = true

#solver_options = '-ksp_type preonly -pc_type lu -pc_factor_mat_solver_package superlu_dist'

#gamg seems better than hypre (similar to ml)
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 70 -ns3d_ksp_type fgmres -ns3d_pc_fieldsplit_detect_saddle_point -ns3d_pc_type fieldsplit  -ns3d_fieldsplit_0_ksp_type preonly -ns3d_fieldsplit_0_pc_type ml -ns3d_fieldsplit_1_pc_type lsc -ns3d_fieldsplit_1_ksp_type gmres -ns3d_fieldsplit_1_lsc_pc_type ml -ns3d_fieldsplit_1_ksp_max_it 30 -ns3d_fieldsplit_1_lsc_scale_diag -ns3d_fieldsplit_1_ksp_rtol 1e-2 -ns3d_fieldsplit_1_lsc_pc_mg_cycles 2 -ns3d_fieldsplit_0_pc_mg_levels 3 -ns3d_fieldsplit_0_pc_mg_type multiplicative -ns3d_ksp_view -ns3d_ksp_monitor -ns3d_fieldsplit_1_ksp_monitor' # -ns3d_ksp_monitor  -ns3d_ksp_view'
#  -ns3d_fieldsplit_1_ksp_max_it 2

# stabilised i.e. linear elements 2D/3D
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 70 -ns3d_ksp_type fgmres -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_detect_saddle_point -ns3d_pc_fieldsplit_type multiplicative -ns3d_pc_fieldsplit_block_size 4 -ns3d_pc_fieldsplit_0_fields 0,1,2 -ns3d_pc_fieldsplit_1_fields 3 -ns3d_fieldsplit_0_ksp_type gmres -ns3d_fieldsplit_0_pc_type lu -ns3d_fieldsplit_1_pc_type gamg -ns3d_fieldsplit_1_ksp_type gmres -ns3d_fieldsplit_1_ksp_max_it 30 -ns3d_ksp_monitor' # -ns3d_ksp_monitor  -ns3d_ksp_view'
#  -ns3d_fieldsplit_1_ksp_max_it 2
#-ns3d_fieldsplit_1_lsc_pc_mg_cycles 2 -ns3d_fieldsplit_0_pc_mg_levels 3 -ns3d_fieldsplit_0_pc_mg_type multiplicative

#hypre and gamg are okay
#hypre boomeramg works nice, parasails/euclid is slow, pilut doesn't work
# changing maxit means it solves the correct problem better, default is 2
# 3x faster than superlu
# need to try within a block preconditioner
# hypre gets more stuck
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 70 -ns3d_ksp_type gmres -ns3d_pc_type ml -ns3d_pc_hypre_type boomeramg -ns3d_mg_levels_ksp_type gmres -ns3d_mg_levels_ksp_max_it 50 -ns3d_mg_levels_pc_type asm -ns3d_mg_levels_sub_pc_type ilu -ns3d_ksp_monitor  -ns3d_ksp_view'

#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 70 -ns3d_ksp_type lgmres -ns3d_ksp_gmres_restart 30 -ns3d_pc_asm_overlap 2 -ns3d_sub_pc_type ilu -ns3d_sub_pc_factor_zeropivot 0 -ns3d_sub_pc_ilu_levels 3'# -ns3d_pc_type asm' # -ns3d_ksp_monitor  -ns3d_ksp_view'

#solver_options = '-ns3d_ksp_type fgmres -ns3d_pc_type fieldsplit -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_block_size 4 -ns3d_pc_fieldsplit_0_fields 0,1,2 -ns3d_pc_fieldsplit_1_fields 3'# -ns3d_ksp_view'
 
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 70 -ns3d_ksp_type gmres'# -ns3d_ksp_view'
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps -mat_mumps_icntl_28 2 -mat_mumps_icntl_14 70 -ns3d_ksp_type minres'# -ns3d_ksp_view'
#solver_options = '-ns3d_ksp_type fgmres -ns3d_ksp_diagonal_scale -ns3d_ksp_rtol 1.0e-10 -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_block_size 3 -ns3d_pc_fieldsplit_0_fields 0,1 -ns3d_pc_fieldsplit_1_fields 2 -ns3d_pc_fieldsplit_type schur -ns3d_pc_fieldsplit_schur_factorization_type upper -ns3d_fieldsplit_0_ksp_type cg  -ns3d_fieldsplit_0_ksp_rtol 1.0e-6 -ns3d_fieldsplit_0_pc_type bjacobi -ns3d_fieldsplit_0_sub_pc_type cholesky -ns3d_fieldsplit_0_sub_pc_factor_mat_ordering_type nd -ns3d_fieldsplit_1_ksp_type fgmres -ns3d_fieldsplit_1_ksp_constant_null_space  -ns3d_fieldsplit_1_ksp_monitor_short -ns3d_fieldsplit_1_pc_type lsc -ns3d_fieldsplit_1_lsc_ksp_type cg -ns3d_fieldsplit_1_lsc_ksp_rtol 1.0e-2 -ns3d_fieldsplit_1_lsc_ksp_constant_null_space -ns3d_fieldsplit_1_lsc_ksp_converged_reason -ns3d_fieldsplit_1_lsc_pc_type bjacobi -ns3d_fieldsplit_1_lsc_sub_pc_type icc'

# okay this seems to be okay
#solver_options = '-ns3d_ksp_type fgmres -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_detect_saddle_point -ns3d_pc_fieldsplit_block_size 4 -ns3d_pc_fieldsplit_0_fields 0,1,2 -ns3d_pc_fieldsplit_1_fields 3 -ns3d_pc_fieldsplit_type schur -ns3d_pc_fieldsplit_schur_factorization_type upper -ns3d_fieldsplit_0_ksp_type preonly -ns3d_fieldsplit_0_pc_type lu -ns3d_fieldsplit_1_ksp_type preonly -ns3d_fieldsplit_1_pc_type lu'

# problem doing asm with more blocks sigh, have to do the same as processors
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type asm -ns3d_pc_hypre_type euclid -ns3d_ksp_max_it 1000'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type bjacobi -ns3d_pc_bjacobi_blocks 5 -ns3d_ksp_view -ns3d_pc_hypre_type euclid -ns3d_ksp_max_it 1000'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type bjacobi -ns3d_sub_pc_type hypre -ns3d_sub_pc_hypre_type euclid -ns3d_ksp_max_it 1000'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type bjacobi -ns3d_sub_ksp_type preonly -ns3d_sub_pc_type ilu'
#solver_options = '-ns3d_ksp_view'

#stokes only  working
#stokes_solver_options = '-ns3d_ksp_type fgmres -ns3d_ksp_diagonal_scale -ns3d_ksp_rtol 1.0e-10 -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_block_size 3 -ns3d_pc_fieldsplit_0_fields 0,1 -ns3d_pc_fieldsplit_1_fields 2 -ns3d_pc_fieldsplit_type schur -ns3d_pc_fieldsplit_schur_factorization_type upper -ns3d_fieldsplit_0_ksp_type cg  -ns3d_fieldsplit_0_ksp_rtol 1.0e-6 -ns3d_fieldsplit_0_pc_type bjacobi -ns3d_fieldsplit_0_sub_pc_type cholesky -ns3d_fieldsplit_0_sub_pc_factor_mat_ordering_type nd -ns3d_fieldsplit_1_ksp_type gmres -ns3d_fieldsplit_1_pc_type bjacobi -ns3d_fieldsplit_1_ksp_rtol 1.0e-1'

3D
#stokes_solver_options = '-ns3d_ksp_type fgmres -ns3d_ksp_diagonal_scale -ns3d_ksp_rtol 1.0e-10 -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_block_size 4 -ns3d_pc_fieldsplit_0_fields 0,1,2 -ns3d_pc_fieldsplit_1_fields 3 -ns3d_pc_fieldsplit_type schur -ns3d_pc_fieldsplit_schur_factorization_type upper -ns3d_fieldsplit_0_ksp_type cg  -ns3d_fieldsplit_0_ksp_rtol 1.0e-6 -ns3d_fieldsplit_0_pc_type bjacobi -ns3d_fieldsplit_0_sub_pc_type cholesky -ns3d_fieldsplit_0_sub_pc_factor_mat_ordering_type nd -ns3d_fieldsplit_1_ksp_type gmres -ns3d_fieldsplit_1_pc_type bjacobi -ns3d_fieldsplit_1_ksp_rtol 1.0e-1 -ns3d_ksp_monitor'

2D
stokes_solver_options = '-ns3d_ksp_type fgmres -ns3d_ksp_diagonal_scale -ns3d_ksp_rtol 1.0e-10 -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_block_size 3 -ns3d_pc_fieldsplit_0_fields 0,1 -ns3d_pc_fieldsplit_1_fields 2 -ns3d_pc_fieldsplit_type schur -ns3d_pc_fieldsplit_schur_factorization_type upper -ns3d_fieldsplit_0_ksp_type cg  -ns3d_fieldsplit_0_ksp_rtol 1.0e-6 -ns3d_fieldsplit_0_pc_type bjacobi -ns3d_fieldsplit_0_sub_pc_type cholesky -ns3d_fieldsplit_0_sub_pc_factor_mat_ordering_type nd -ns3d_fieldsplit_1_ksp_type gmres -ns3d_fieldsplit_1_pc_type bjacobi -ns3d_fieldsplit_1_ksp_rtol 1.0e-1'

#stokes_solver_options = '-ns3d_ksp_max_it 20 -ns3d_ksp_type fgmres -ns3d_ksp_diagonal_scale -ns3d_ksp_rtol 1.0e-10 -ns3d_pc_type fieldsplit -ns3d_pc_fieldsplit_block_size 3 -ns3d_pc_fieldsplit_0_fields 0,1 -ns3d_pc_fieldsplit_1_fields 2 -ns3d_pc_fieldsplit_type schur -ns3d_pc_fieldsplit_schur_factorization_type upper -ns3d_fieldsplit_0_ksp_type cg  -ns3d_fieldsplit_0_ksp_rtol 1.0e-6 -ns3d_fieldsplit_0_pc_type bjacobi -ns3d_fieldsplit_0_sub_pc_type cholesky -ns3d_fieldsplit_0_sub_pc_factor_mat_ordering_type nd -ns3d_fieldsplit_1_ksp_type cg -ns3d_fieldsplit_1_pc_type ml -ns3d_fieldsplit_1_ksp_rtol 1.0e-2 '


#general
# note hard to get parallel solvers, e.g. ilu scales badly
# hypre pc_hypre_type pilut is okay, euclid is great, better than ilu, bjacobi euclid not as good
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type hypre -ns3d_pc_hypre_type euclid -ns3d_ksp_max_it 1000'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type asm -ns3d_sub_ksp_type preonly -ns3d_sub_pc_type lu -ns3d_ksp_view'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type asm -ns3d_pc_asm_blocks 5 -ns3d_sub_ksp_type gmres -ns3d_sub_pc_type ilu -ns3d_ksp_view'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type ml -ns3d_mg_levels_ksp_type gmres -ns3d_mg_levels_ksp_max_it 1000 -ns3d_mg_levels_pc_type asm -ns3d_ksp_view'
#solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package umfpack -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package umfpack'

#stokes_solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package mumps'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type ilu'
#solver_options = '-ns3d_ksp_type gmres -ns3d_pc_type hypre -ns3d_pc_hypre_type euclid -ns3d_ksp_max_it 10000'
solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package umfpack -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package umfpack'
stokes_solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package umfpack -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package umfpack'


#solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package superlu_dist -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package superlu_dist'
#stokes_solver_options = '-ns3d_ksp_type preonly -ns3d_pc_type lu -ns3d_pc_factor_mat_solver_package superlu_dist -ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package superlu_dist'


#1d options
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package umfpack'# -ns1d_ksp_view'
#solver_options = '-ns1d_ksp_type preonly -ns1d_pc_type lu -ns1d_pc_factor_mat_solver_package mumps'#  -ns1d_ksp_view'
#solver_options = '-ns1d_ksp_type gmres -ns1d_ksp_max_it 12 -ns1d_pc_type ilu -ns1d_ksp_pc_side right -ns1d_ksp_view'


   

